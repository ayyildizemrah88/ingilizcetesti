{% extends "dashboard.html" %}
{% block title %}Audit Log - Skills Test Center{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-journal-text me-2"></i>Denetim Günlüğü</h2>
            <div class="d-flex gap-2">
                <select class="form-select w-auto" id="actionFilter">
                    <option value="">Tüm İşlemler</option>
                    <option value="CREATE">Oluşturma</option>
                    <option value="UPDATE">Güncelleme</option>
                    <option value="DELETE">Silme</option>
                    <option value="VIEW">Görüntüleme</option>
                    <option value="EXPORT">Dışa Aktarma</option>
                </select>
                <select class="form-select w-auto" id="entityFilter">
                    <option value="">Tüm Varlıklar</option>
                    <option value="candidate">Aday</option>
                    <option value="question">Soru</option>
                    <option value="company">Şirket</option>
                    <option value="user">Kullanıcı</option>
                </select>
                <input type="date" class="form-control w-auto" id="dateFilter">
                <a href="/admin/export-audit" class="btn btn-outline-primary">
                    <i class="bi bi-download me-1"></i>Excel
                </a>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="display-5 text-primary">{{ stats.today }}</div>
                <small class="text-muted">Bugün</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="display-5 text-info">{{ stats.week }}</div>
                <small class="text-muted">Bu Hafta</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="display-5 text-success">{{ stats.active_admins }}</div>
                <small class="text-muted">Aktif Admin</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="display-5 text-warning">{{ stats.most_active }}</div>
                <small class="text-muted">En Aktif</small>
            </div>
        </div>
    </div>

    <!-- Log Table -->
    <div class="col-12 mt-4">
        <div class="card border-0 shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="auditTable">
                        <thead class="table-light">
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>Kullanıcı</th>
                                <th>İşlem</th>
                                <th>Varlık</th>
                                <th>Açıklama</th>
                                <th>IP</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr data-action="{{ log.action }}" data-entity="{{ log.entity_type }}">
                                <td>
                                    <small>{{ log.created_at.strftime('%d.%m.%Y') }}</small><br>
                                    <small class="text-muted">{{ log.created_at.strftime('%H:%M:%S') }}</small>
                                </td>
                                <td>
                                    <strong>{{ log.user_email }}</strong><br>
                                    <small class="badge bg-secondary">{{ log.user_role }}</small>
                                </td>
                                <td>
                                    {% if log.action == 'CREATE' %}
                                    <span class="badge bg-success">Oluşturma</span>
                                    {% elif log.action == 'UPDATE' %}
                                    <span class="badge bg-info">Güncelleme</span>
                                    {% elif log.action == 'DELETE' %}
                                    <span class="badge bg-danger">Silme</span>
                                    {% elif log.action == 'EXPORT' %}
                                    <span class="badge bg-warning">Dışa Aktarma</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ log.action }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ log.entity_type }}</span>
                                    <br><small>#{{ log.entity_id }}</small>
                                </td>
                                <td>{{ log.description or '-' }}</td>
                                <td><small class="text-muted">{{ log.ip_address or '-' }}</small></td>
                                <td>
                                    {% if log.old_value or log.new_value %}
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showDiff({{ log.id }})">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Pagination -->
            <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                <small class="text-muted">{{ total }} kayıt</small>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {% for p in range(1, pages + 1) %}
                        <li class="page-item {% if p == page %}active{% endif %}">
                            <a class="page-link" href="?page={{ p }}">{{ p }}</a>
                        </li>
                        {% endfor %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Diff Modal -->
<div class="modal fade" id="diffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Değişiklik Detayı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-6">
                        <h6 class="text-danger">Önceki</h6>
                        <pre id="oldValue" class="bg-light p-3 rounded"></pre>
                    </div>
                    <div class="col-6">
                        <h6 class="text-success">Sonraki</h6>
                        <pre id="newValue" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Filters
    document.getElementById('actionFilter').onchange = filterTable;
    document.getElementById('entityFilter').onchange = filterTable;

    function filterTable() {
        const action = document.getElementById('actionFilter').value;
        const entity = document.getElementById('entityFilter').value;

        document.querySelectorAll('#auditTable tbody tr').forEach(row => {
            const matchAction = !action || row.dataset.action === action;
            const matchEntity = !entity || row.dataset.entity === entity;
            row.style.display = matchAction && matchEntity ? '' : 'none';
        });
    }

    function showDiff(logId) {
        fetch(`/api/audit/${logId}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('oldValue').textContent =
                    JSON.stringify(data.old_value, null, 2) || '-';
                document.getElementById('newValue').textContent =
                    JSON.stringify(data.new_value, null, 2) || '-';
                new bootstrap.Modal(document.getElementById('diffModal')).show();
            });
    }
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Sınav - Skills Test Center{% endblock %}
{% block extra_css %}
<style>
    .timer {
        font-size: 2rem;
        font-weight: bold;
    }

    .timer.warning {
        color: #ffc107;
    }

    .timer.danger {
        color: #dc3545;
        animation: blink 1s infinite;
    }

    @keyframes blink {
        50% {
            opacity: 0.5;
        }
    }

    .option-btn {
        transition: all 0.3s;
    }

    .option-btn:hover {
        transform: scale(1.02);
    }

    .option-btn.selected {
        border-color: #0d6efd !important;
        background: #e7f1ff;
    }

    /* Güvenlik: Seçim engelleme */
    .exam-content {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    /* Tab değiştirme uyarısı */
    .tab-warning-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(220, 53, 69, 0.95);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5rem;
        text-align: center;
        padding: 2rem;
    }
</style>
{% endblock %}
{% block content %}
<!-- Tab değiştirme uyarı overlay'i -->
<div id="tabWarningOverlay" class="tab-warning-overlay">
    <div>
        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
        <h2>Sınav Sayfasından Ayrıldınız!</h2>
        <p>Lütfen sınav tamamlanana kadar bu sayfada kalın.</p>
        <p class="text-warning">Bu durum kayıt altına alınmıştır.</p>
    </div>
</div>

<div class="row exam-content">
    <div class="col-lg-8 mx-auto">
        <div class="card border-0 mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <div>
                    <span class="badge bg-primary fs-6">Soru {{ soru_no }} / {{ toplam }}</span>
                </div>
                <div class="d-flex align-items-center gap-3">
                    {% if soru_suresi and soru_suresi > 0 %}
                    <div class="text-center">
                        <small class="text-muted d-block">Soru Süresi</small>
                        <div class="timer text-info" id="questionTimer">--:--</div>
                    </div>
                    {% endif %}
                    <div class="text-center">
                        <small class="text-muted d-block">Toplam</small>
                        <div class="timer" id="timer">--:--</div>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="progress mb-4" style="height: 8px;">
                    <div class="progress-bar" style="width: {{ (soru_no / toplam * 100)|int }}%"></div>
                </div>
                <h4 class="mb-4">{{ soru.soru_metni }}</h4>
                <form method="POST" action="{{ url_for('exam.sinav_cevap') }}" id="examForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="soru_id" value="{{ soru.id }}">
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'A')">
                            <strong class="me-3">A)</strong> {{ soru.secenek_a }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'B')">
                            <strong class="me-3">B)</strong> {{ soru.secenek_b }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'C')">
                            <strong class="me-3">C)</strong> {{ soru.secenek_c }}
                        </button>
                        {% if soru.secenek_d %}
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'D')">
                            <strong class="me-3">D)</strong> {{ soru.secenek_d }}
                        </button>
                        {% endif %}
                    </div>
                    <input type="hidden" name="cevap" id="selectedAnswer" value="">
                    <div class="d-flex justify-content-end mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn" disabled>
                            Sonraki <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ==================== YAPILANDIRMA ====================
    let remainingSeconds = {{ kalan_sure }};
    let questionSeconds = {{ soru_suresi or 0 }};
    const timerEl = document.getElementById('timer');
    const questionTimerEl = document.getElementById('questionTimer');
    const OFFLINE_KEY = 'skills_offline_answers';
    let webcamStream = null;

    // CSRF Token - Proctoring için gerekli
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

    // Tab değiştirme sayacı
    let tabSwitchCount = 0;

    // DÜZELTİLDİ: İlk 5 saniye tab değişikliklerini ignore et (kamera izni için)
    let ignoreTabSwitch = true;
    let lastTabSwitchTime = 0;
    setTimeout(() => { ignoreTabSwitch = false; }, 5000);

    // ==================== ZAMANLAYICILAR ====================
    function updateTimer() {
        const mins = Math.floor(remainingSeconds / 60);
        const secs = remainingSeconds % 60;
        timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        if (remainingSeconds <= 60) {
            timerEl.classList.add('danger');
        } else if (remainingSeconds <= 300) {
            timerEl.classList.add('warning');
        }

        if (remainingSeconds <= 0) {
            document.getElementById('examForm').submit();
            return;
        }

        remainingSeconds--;
        setTimeout(updateTimer, 1000);
    }

    function updateQuestionTimer() {
        if (!questionTimerEl || questionSeconds <= 0) return;

        const mins = Math.floor(questionSeconds / 60);
        const secs = questionSeconds % 60;
        questionTimerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        if (questionSeconds <= 10) {
            questionTimerEl.classList.remove('text-info');
            questionTimerEl.classList.add('danger');
        } else if (questionSeconds <= 30) {
            questionTimerEl.classList.remove('text-info');
            questionTimerEl.classList.add('warning');
        }

        if (questionSeconds <= 0) {
            document.getElementById('examForm').submit();
            return;
        }

        questionSeconds--;
        setTimeout(updateQuestionTimer, 1000);
    }

    // ==================== SEÇENEK İŞLEMLERİ ====================
    function selectOption(btn, answer) {
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('selectedAnswer').value = answer;
        document.getElementById('submitBtn').disabled = false;

        saveOfflineAnswer({{ soru.id }}, answer);
    }

    // ==================== ÇEVRİMDIŞI MOD ====================
    function saveOfflineAnswer(soruId, answer) {
        try {
            let answers = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
            answers = answers.filter(a => a.soru_id !== soruId);
            answers.push({
                soru_id: soruId,
                answer: answer,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(OFFLINE_KEY, JSON.stringify(answers));
        } catch (e) {
            console.warn('LocalStorage not available', e);
        }
    }

    async function syncOfflineAnswers() {
        try {
            const answers = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
            if (answers.length === 0) return;

            const resp = await fetch('/api/offline/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ answers: answers })
            });

            if (resp.ok) {
                localStorage.removeItem(OFFLINE_KEY);
                console.log('Offline answers synced');
            }
        } catch (e) {
            console.warn('Sync failed, will retry later', e);
        }
    }

    // ==================== WEBCAM PROCTORING - DÜZELTİLDİ ====================
    async function initWebcam() {
        try {
            webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            console.log('Webcam initialized for proctoring');

            // İlk snapshot'ı hemen al
            setTimeout(captureSnapshot, 2000);
            // Her 30 saniyede bir snapshot al
            setInterval(captureSnapshot, 30000);
        } catch (e) {
            console.warn('Webcam not available:', e);
        }
    }

    async function captureSnapshot() {
        if (!webcamStream) {
            console.warn('Webcam stream not available');
            return;
        }

        try {
            const video = document.createElement('video');
            video.srcObject = webcamStream;
            await video.play();

            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 240;
            canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);

            // Data URL formatında görüntü
            const imageData = canvas.toDataURL('image/png', 0.7);

            // DÜZELTİLDİ: CSRF Token header'a eklendi
            const resp = await fetch('/api/proctoring/snapshot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken  // CSRF Token eklendi
                },
                body: JSON.stringify({ image: imageData })
            });

            if (resp.ok) {
                console.log('Proctoring snapshot captured successfully');
            } else {
                console.warn('Proctoring snapshot failed:', resp.status);
            }
        } catch (e) {
            console.warn('Snapshot failed:', e);
        }
    }

    // ==================== GÜVENLİK TEDBİRLERİ ====================

    // 1. Sağ tık engelleme
    document.addEventListener('contextmenu', function (e) {
        e.preventDefault();
        console.log('Sağ tık engellendi');
        return false;
    });

    // 2. Kopyalama engelleme
    document.addEventListener('copy', function (e) {
        e.preventDefault();
        console.log('Kopyalama engellendi');
        return false;
    });

    // 3. Yapıştırma engelleme
    document.addEventListener('paste', function (e) {
        e.preventDefault();
        console.log('Yapıştırma engellendi');
        return false;
    });

    // 4. Kesme engelleme
    document.addEventListener('cut', function (e) {
        e.preventDefault();
        console.log('Kesme engellendi');
        return false;
    });

    // 5. Tab/Pencere değiştirme tespiti - DÜZELTİLDİ
    document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
            // İlk 5 saniye ignore et (kamera izni popup'ları için)
            if (ignoreTabSwitch) {
                console.log('Tab değişikliği ignore edildi (başlangıç)');
                return;
            }

            // Debounce: 2 saniye içinde tekrar tetiklenmesini engelle
            const now = Date.now();
            if (now - lastTabSwitchTime < 2000) {
                console.log('Tab değişikliği ignore edildi (debounce)');
                return;
            }
            lastTabSwitchTime = now;

            tabSwitchCount++;
            console.log('Tab değiştirildi! Toplam:', tabSwitchCount);

            // Uyarı overlay göster
            document.getElementById('tabWarningOverlay').style.display = 'flex';

            // Sunucuya bildir
            logSecurityEvent('tab_switch', { count: tabSwitchCount });

            // 2 saniye sonra overlay'i gizle
            setTimeout(() => {
                document.getElementById('tabWarningOverlay').style.display = 'none';
            }, 2000);
        }
    });

    // 6. Blur (odak kaybı) tespiti - DÜZELTİLDİ
    window.addEventListener('blur', function () {
        // İlk 5 saniye ignore et
        if (ignoreTabSwitch) {
            console.log('Blur ignore edildi (başlangıç)');
            return;
        }
        console.log('Pencere odağı kaybedildi');
        logSecurityEvent('window_blur', {});
    });

    // 7. Kısayol tuşları engelleme (Ctrl+C, Ctrl+V, Ctrl+A, F12, PrintScreen vb.)
    document.addEventListener('keydown', function (e) {
        // F12 (DevTools)
        if (e.key === 'F12') {
            e.preventDefault();
            console.log('F12 engellendi');
            return false;
        }

        // Ctrl + tuş kombinasyonları
        if (e.ctrlKey) {
            // Ctrl+C, Ctrl+V, Ctrl+X, Ctrl+A, Ctrl+U, Ctrl+S, Ctrl+P
            if (['c', 'v', 'x', 'a', 'u', 's', 'p', 'C', 'V', 'X', 'A', 'U', 'S', 'P'].includes(e.key)) {
                e.preventDefault();
                console.log('Ctrl+' + e.key + ' engellendi');
                return false;
            }
            // Ctrl+Shift+I (DevTools)
            if (e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j')) {
                e.preventDefault();
                console.log('DevTools kısayolu engellendi');
                return false;
            }
        }

        // PrintScreen
        if (e.key === 'PrintScreen') {
            e.preventDefault();
            console.log('PrintScreen engellendi');
            return false;
        }
    });

    // 8. Güvenlik olaylarını sunucuya bildir
    async function logSecurityEvent(eventType, data) {
        try {
            await fetch('/api/security/log', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    event_type: eventType,
                    data: data,
                    timestamp: new Date().toISOString()
                })
            });
        } catch (e) {
            console.warn('Security log failed:', e);
        }
    }

    // ==================== AĞ DURUMU ====================
    window.addEventListener('online', () => {
        console.log('Back online, syncing...');
        syncOfflineAnswers();
    });

    window.addEventListener('offline', () => {
        console.log('Offline mode activated');
    });

    // ==================== DURAKLATMA ====================
    async function pauseExam() {
        if (!confirm('Sınavı duraklatmak istiyor musunuz? Kaldığınız yerden devam edebilirsiniz.')) {
            return;
        }

        try {
            const resp = await fetch('/exam/sinav/pause', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ current_question_id: {{ soru.id }} })
    });

    const data = await resp.json();

    if (data.status === 'paused') {
        alert(data.message);
        window.location.href = '/sinav-giris';
    } else if (data.status === 'already_paused') {
        alert('Sınav zaten duraklatılmış.');
    }
        } catch (e) {
        console.error('Pause failed:', e);
        alert('Duraklatma başarısız. İnternet bağlantınızı kontrol edin.');
    }
    }

    // ==================== BAŞLATMA ====================
    updateTimer();
    updateQuestionTimer();
    initWebcam();
    syncOfflineAnswers();

    console.log('Sınav güvenlik sistemi aktif');
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Sınav - Skills Test Center{% endblock %}
{% block extra_css %}
<style>
    .timer {
        font-size: 2rem;
        font-weight: bold;
    }

    .timer.warning {
        color: #ffc107;
    }

    .timer.danger {
        color: #dc3545;
        animation: blink 1s infinite;
    }

    @keyframes blink {
        50% {
            opacity: 0.5;
        }
    }

    .option-btn {
        transition: all 0.3s;
    }

    .option-btn:hover {
        transform: scale(1.02);
    }

    .option-btn.selected {
        border-color: #0d6efd !important;
        background: #e7f1ff;
    }

    /* Güvenlik: Seçim engelleme */
    .exam-content {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    /* Tab değiştirme uyarısı */
    .tab-warning-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(220, 53, 69, 0.95);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5rem;
        text-align: center;
        padding: 2rem;
    }

    /* Speaking/Writing Arayüzleri */
    .speaking-interface, .writing-interface {
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .audio-recorder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        padding: 2rem;
    }

    .audio-recorder .btn {
        width: 200px;
    }

    .recording-indicator {
        display: none;
        align-items: center;
        gap: 0.5rem;
        color: #dc3545;
        font-weight: bold;
    }

    .recording-indicator.active {
        display: flex;
    }

    .pulse {
        width: 12px;
        height: 12px;
        background: #dc3545;
        border-radius: 50%;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }

    .word-count {
        font-size: 0.9rem;
    }

    .word-count.warning {
        color: #ffc107;
    }

    .word-count.success {
        color: #28a745;
    }
</style>
{% endblock %}
{% block content %}
<!-- Tab değiştirme uyarı overlay'i -->
<div id="tabWarningOverlay" class="tab-warning-overlay">
    <div>
        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
        <h2>Sınav Sayfasından Ayrıldınız!</h2>
        <p>Lütfen sınav tamamlanana kadar bu sayfada kalın.</p>
        <p class="text-warning">Bu durum kayıt altına alınmıştır.</p>
    </div>
</div>

<div class="row exam-content">
    <div class="col-lg-8 mx-auto">
        <div class="card border-0 mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <div>
                    <span class="badge bg-primary fs-6">Soru {{ soru_no }} / {{ toplam }}</span>
                    {% if soru.beceri %}
                    <span class="badge bg-secondary ms-2">{{ soru.beceri|capitalize }}</span>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center gap-3">
                    {% if soru_suresi and soru_suresi > 0 %}
                    <div class="text-center">
                        <small class="text-muted d-block">Soru Süresi</small>
                        <div class="timer text-info" id="questionTimer">--:--</div>
                    </div>
                    {% endif %}
                    <div class="text-center">
                        <small class="text-muted d-block">Toplam</small>
                        <div class="timer" id="timer">--:--</div>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="progress mb-4" style="height: 8px;">
                    <div class="progress-bar" style="width: {{ (soru_no / toplam * 100)|int }}%"></div>
                </div>
                <h4 class="mb-4">{{ soru.soru_metni }}</h4>
                
                <form method="POST" action="{{ url_for('exam.sinav_cevap') }}" id="examForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="soru_id" value="{{ soru.id }}">
                    <input type="hidden" name="soru_tipi" value="{{ soru.beceri or 'grammar' }}">
                    
                    {% if soru.beceri == 'speaking' %}
                    <!-- ============ SPEAKING: Ses Kayıt Arayüzü ============ -->
                    <div class="speaking-interface">
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-microphone me-2"></i>
                            <strong>Konuşma Sorusu:</strong> Soruyu okuyun ve cevabınızı sesli olarak kaydedin.
                        </div>
                        
                        <div class="audio-recorder">
                            <div class="recording-indicator" id="recordingIndicator">
                                <div class="pulse"></div>
                                <span>Kayıt yapılıyor...</span>
                            </div>
                            
                            <button type="button" id="startRecording" class="btn btn-danger btn-lg">
                                <i class="fas fa-microphone me-2"></i> Kayda Başla
                            </button>
                            <button type="button" id="stopRecording" class="btn btn-secondary btn-lg" disabled>
                                <i class="fas fa-stop me-2"></i> Kaydı Durdur
                            </button>
                            
                            <audio id="audioPlayback" controls style="display:none; width: 100%; max-width: 400px;"></audio>
                            
                            <p class="text-muted small mt-3">
                                <i class="fas fa-info-circle me-1"></i>
                                Kayıt tamamlandığında otomatik olarak değerlendirilecektir.
                            </p>
                        </div>
                        
                        <input type="hidden" name="audio_response" id="audioResponse">
                        <input type="hidden" name="cevap" id="selectedAnswer" value="">
                    </div>
                    
                    {% elif soru.beceri == 'writing' %}
                    <!-- ============ WRITING: Yazı Alanı ============ -->
                    <div class="writing-interface">
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-pencil-alt me-2"></i>
                            <strong>Yazma Sorusu:</strong> Aşağıdaki alana cevabınızı yazın.
                        </div>
                        
                        <textarea name="text_response" id="textResponse" class="form-control" 
                                  rows="12" placeholder="Cevabınızı buraya yazın..."
                                  style="font-size: 1.1rem; line-height: 1.8;"></textarea>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="word-count" id="wordCountDisplay">
                                Kelime sayısı: <span id="wordCount">0</span> / <span class="text-muted">Önerilen: 150+</span>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Yazınız AI tarafından değerlendirilecektir.
                            </small>
                        </div>
                        
                        <input type="hidden" name="cevap" id="selectedAnswer" value="WRITING_SUBMITTED">
                    </div>
                    
                    {% else %}
                    <!-- ============ ÇOGtan SEÇMELİ: Standart Format ============ -->
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'A')">
                            <strong class="me-3">A)</strong> {{ soru.secenek_a }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'B')">
                            <strong class="me-3">B)</strong> {{ soru.secenek_b }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'C')">
                            <strong class="me-3">C)</strong> {{ soru.secenek_c }}
                        </button>
                        {% if soru.secenek_d %}
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'D')">
                            <strong class="me-3">D)</strong> {{ soru.secenek_d }}
                        </button>
                        {% endif %}
                    </div>
                    <input type="hidden" name="cevap" id="selectedAnswer" value="">
                    {% endif %}
                    
                    <div class="d-flex justify-content-end mt-4">
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn" 
                                {% if soru.beceri not in ['speaking', 'writing'] %}disabled{% endif %}>
                            Sonraki <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ==================== YAPILANDIRMA ====================
    let remainingSeconds = {{ kalan_sure }};
    let questionSeconds = {{ soru_suresi or 0 }};
    const timerEl = document.getElementById('timer');
    const questionTimerEl = document.getElementById('questionTimer');
    const OFFLINE_KEY = 'skills_offline_answers';
    let webcamStream = null;
    let mediaRecorder = null;
    let audioChunks = [];

    // CSRF Token - Proctoring için gerekli
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

    // Tab değiştirme sayacı
    let tabSwitchCount = 0;

    // DÜZELTİLDİ: İlk 5 saniye tab değişikliklerini ignore et (kamera izni için)
    let ignoreTabSwitch = true;
    let lastTabSwitchTime = 0;
    setTimeout(() => { ignoreTabSwitch = false; }, 5000);

    // Soru tipi
    const soruTipi = '{{ soru.beceri or "grammar" }}';

    // ==================== ZAMANLAYICILAR ====================
    function updateTimer() {
        const mins = Math.floor(remainingSeconds / 60);
        const secs = remainingSeconds % 60;
        timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        if (remainingSeconds <= 60) {
            timerEl.classList.add('danger');
        } else if (remainingSeconds <= 300) {
            timerEl.classList.add('warning');
        }

        if (remainingSeconds <= 0) {
            // DÜZELTİLDİ: Süre dolduğunda formu otomatik gönder
            autoSubmitForm();
            return;
        }

        remainingSeconds--;
        setTimeout(updateTimer, 1000);
    }

    function updateQuestionTimer() {
        if (!questionTimerEl || questionSeconds <= 0) return;

        const mins = Math.floor(questionSeconds / 60);
        const secs = questionSeconds % 60;
        questionTimerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        if (questionSeconds <= 10) {
            questionTimerEl.classList.remove('text-info');
            questionTimerEl.classList.add('danger');
        } else if (questionSeconds <= 30) {
            questionTimerEl.classList.remove('text-info');
            questionTimerEl.classList.add('warning');
        }

        if (questionSeconds <= 0) {
            // DÜZELTİLDİ: Soru süresi dolduğunda otomatik sonraki soruya geç
            autoSubmitForm();
            return;
        }

        questionSeconds--;
        setTimeout(updateQuestionTimer, 1000);
    }

    // DÜZELTİLDİ: Otomatik form gönderimi
    function autoSubmitForm() {
        const form = document.getElementById('examForm');
        const submitBtn = document.getElementById('submitBtn');
        
        // Cevap seçilmemişse boş olarak işaretle
        const selectedAnswer = document.getElementById('selectedAnswer');
        if (!selectedAnswer.value && soruTipi !== 'speaking' && soruTipi !== 'writing') {
            selectedAnswer.value = '';  // Boş cevap - süre doldu
        }
        
        // Writing için metin kontrolü
        if (soruTipi === 'writing') {
            const textResponse = document.getElementById('textResponse');
            if (textResponse && !textResponse.value.trim()) {
                selectedAnswer.value = 'TIMEOUT_EMPTY';
            }
        }
        
        // Submit butonunu aktifle ve formu gönder
        submitBtn.disabled = false;
        form.submit();
    }

    // ==================== SEÇENEK İŞLEMLERİ ====================
    function selectOption(btn, answer) {
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('selectedAnswer').value = answer;
        document.getElementById('submitBtn').disabled = false;

        saveOfflineAnswer({{ soru.id }}, answer);
    }

    // ==================== WRITING KELIME SAYACI ====================
    if (soruTipi === 'writing') {
        const textArea = document.getElementById('textResponse');
        const wordCountEl = document.getElementById('wordCount');
        const wordCountDisplay = document.getElementById('wordCountDisplay');
        
        if (textArea) {
            textArea.addEventListener('input', function() {
                const text = this.value.trim();
                const wordCount = text ? text.split(/\s+/).length : 0;
                wordCountEl.textContent = wordCount;
                
                // Minimum kelime kontrolü
                if (wordCount >= 150) {
                    wordCountDisplay.classList.remove('warning');
                    wordCountDisplay.classList.add('success');
                } else if (wordCount >= 100) {
                    wordCountDisplay.classList.remove('success');
                    wordCountDisplay.classList.add('warning');
                } else {
                    wordCountDisplay.classList.remove('success', 'warning');
                }
            });
        }
    }

    // ==================== SPEAKING SES KAYDI ====================
    if (soruTipi === 'speaking') {
        const startBtn = document.getElementById('startRecording');
        const stopBtn = document.getElementById('stopRecording');
        const audioPlayback = document.getElementById('audioPlayback');
        const recordingIndicator = document.getElementById('recordingIndicator');
        const audioResponseInput = document.getElementById('audioResponse');
        const selectedAnswer = document.getElementById('selectedAnswer');

        if (startBtn) {
            startBtn.addEventListener('click', async function() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPlayback.src = audioUrl;
                        audioPlayback.style.display = 'block';

                        // Base64'e çevir
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            audioResponseInput.value = reader.result;
                            selectedAnswer.value = 'SPEAKING_RECORDED';
                            document.getElementById('submitBtn').disabled = false;
                        };
                        reader.readAsDataURL(audioBlob);

                        // Stream'i kapat
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    recordingIndicator.classList.add('active');
                } catch (err) {
                    console.error('Mikrofon erişim hatası:', err);
                    alert('Mikrofona erişilemedi. Lütfen tarayıcı izinlerini kontrol edin.');
                }
            });

            stopBtn.addEventListener('click', function() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    recordingIndicator.classList.remove('active');
                }
            });
        }
    }

    // ==================== ÇEVRİMDIŞI MOD ====================
    function saveOfflineAnswer(soruId, answer) {
        try {
            let answers = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
            answers = answers.filter(a => a.soru_id !== soruId);
            answers.push({
                soru_id: soruId,
                answer: answer,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(OFFLINE_KEY, JSON.stringify(answers));
        } catch (e) {
            console.warn('LocalStorage not available', e);
        }
    }

    async function syncOfflineAnswers() {
        try {
            const answers = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
            if (answers.length === 0) return;

            const resp = await fetch('/api/offline/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ answers: answers })
            });

            if (resp.ok) {
                localStorage.removeItem(OFFLINE_KEY);
                console.log('Offline answers synced');
            }
        } catch (e) {
            console.warn('Sync failed, will retry later', e);
        }
    }

    // ==================== WEBCAM PROCTORING ====================
    async function initWebcam() {
        try {
            webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            console.log('Webcam initialized for proctoring');

            setTimeout(captureSnapshot, 2000);
            setInterval(captureSnapshot, 30000);
        } catch (e) {
            console.warn('Webcam not available:', e);
        }
    }

    async function captureSnapshot() {
        if (!webcamStream) return;

        try {
            const video = document.createElement('video');
            video.srcObject = webcamStream;
            await video.play();

            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 240;
            canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);

            const imageData = canvas.toDataURL('image/png', 0.7);

            await fetch('/api/proctoring/snapshot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ image: imageData })
            });
        } catch (e) {
            console.warn('Snapshot failed:', e);
        }
    }

    // ==================== GÜVENLİK TEDBİRLERİ ====================
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('copy', e => e.preventDefault());
    document.addEventListener('paste', e => e.preventDefault());
    document.addEventListener('cut', e => e.preventDefault());

    document.addEventListener('visibilitychange', function() {
        if (document.hidden && !ignoreTabSwitch) {
            const now = Date.now();
            if (now - lastTabSwitchTime < 2000) return;
            lastTabSwitchTime = now;
            tabSwitchCount++;
            document.getElementById('tabWarningOverlay').style.display = 'flex';
            logSecurityEvent('tab_switch', { count: tabSwitchCount });
            setTimeout(() => {
                document.getElementById('tabWarningOverlay').style.display = 'none';
            }, 2000);
        }
    });

    window.addEventListener('blur', function() {
        if (!ignoreTabSwitch) logSecurityEvent('window_blur', {});
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'F12') { e.preventDefault(); return false; }
        if (e.ctrlKey && ['c','v','x','a','u','s','p'].includes(e.key.toLowerCase())) {
            e.preventDefault(); return false;
        }
    });

    async function logSecurityEvent(eventType, data) {
        try {
            await fetch('/api/security/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ event_type: eventType, data: data, timestamp: new Date().toISOString() })
            });
        } catch (e) {}
    }

    // ==================== AĞ DURUMU ====================
    window.addEventListener('online', () => syncOfflineAnswers());

    // ==================== BAŞLATMA ====================
    updateTimer();
    updateQuestionTimer();
    initWebcam();
    syncOfflineAnswers();

    console.log('Sınav güvenlik sistemi aktif - Soru tipi:', soruTipi);
</script>
{% endblock %}

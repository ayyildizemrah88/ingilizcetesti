{% extends "base.html" %}
{% block title %}Sınav - Skills Test Center{% endblock %}

{% block extra_css %}
<style>
    .timer {
        font-size: 2rem;
        font-weight: bold;
    }

    .timer.warning {
        color: #ffc107;
    }

    .timer.danger {
        color: #dc3545;
        animation: blink 1s infinite;
    }

    @keyframes blink {
        50% {
            opacity: 0.5;
        }
    }

    .option-btn {
        transition: all 0.3s;
    }

    .option-btn:hover {
        transform: scale(1.02);
    }

    .option-btn.selected {
        border-color: #0d6efd !important;
        background: #e7f1ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card border-0 mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <div>
                    <span class="badge bg-primary fs-6">Soru {{ soru_no }} / {{ toplam }}</span>
                    <span class="badge bg-secondary ms-2">{{ soru.zorluk if soru.zorluk else 'B1' }}</span>
                </div>
                <div class="timer" id="timer">--:--</div>
            </div>

            <div class="card-body p-4">
                <div class="progress mb-4" style="height: 8px;">
                    <div class="progress-bar" style="width: {{ (soru_no / toplam * 100)|int }}%"></div>
                </div>

                <h4 class="mb-4">{{ soru.soru_metni }}</h4>

                <form method="POST" action="{{ url_for('exam.sinav_cevap') }}" id="examForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="soru_id" value="{{ soru.id }}">

                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'A')">
                            <strong class="me-3">A)</strong> {{ soru.secenek_a }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'B')">
                            <strong class="me-3">B)</strong> {{ soru.secenek_b }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'C')">
                            <strong class="me-3">C)</strong> {{ soru.secenek_c }}
                        </button>
                        {% if soru.secenek_d %}
                        <button type="button" class="btn btn-outline-secondary btn-lg text-start option-btn p-3"
                            onclick="selectOption(this, 'D')">
                            <strong class="me-3">D)</strong> {{ soru.secenek_d }}
                        </button>
                        {% endif %}
                    </div>

                    <input type="hidden" name="cevap" id="selectedAnswer" value="">

                    <div class="d-flex justify-content-between mt-4">
                        <a href="/candidate/privacy" class="btn btn-outline-secondary">
                            <i class="bi bi-shield-check me-1"></i>Veri Hakları
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="submitBtn" disabled>
                            Sonraki <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let remainingSeconds = {{ kalan_sure }};
    const timerEl = document.getElementById('timer');
    const OFFLINE_KEY = 'skills_offline_answers';
    let webcamStream = null;

    // ══════════════════════════════════════════════════════════════
    // TIMER
    // ══════════════════════════════════════════════════════════════
    function updateTimer() {
        const mins = Math.floor(remainingSeconds / 60);
        const secs = remainingSeconds % 60;
        timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        if (remainingSeconds <= 60) {
            timerEl.classList.add('danger');
        } else if (remainingSeconds <= 300) {
            timerEl.classList.add('warning');
        }

        if (remainingSeconds <= 0) {
            document.getElementById('examForm').submit();
            return;
        }

        remainingSeconds--;
        setTimeout(updateTimer, 1000);
    }

    function selectOption(btn, answer) {
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('selectedAnswer').value = answer;
        document.getElementById('submitBtn').disabled = false;

        // Save to LocalStorage for offline mode
        saveOfflineAnswer({{ soru.id }}, answer);
    }

    // ══════════════════════════════════════════════════════════════
    // OFFLINE MODE - LocalStorage
    // ══════════════════════════════════════════════════════════════
    function saveOfflineAnswer(soruId, answer) {
        try {
            let answers = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
            answers = answers.filter(a => a.soru_id !== soruId);
            answers.push({
                soru_id: soruId,
                answer: answer,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(OFFLINE_KEY, JSON.stringify(answers));
        } catch (e) {
            console.warn('LocalStorage not available', e);
        }
    }

    async function syncOfflineAnswers() {
        try {
            const answers = JSON.parse(localStorage.getItem(OFFLINE_KEY) || '[]');
            if (answers.length === 0) return;

            const resp = await fetch('/api/offline/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ answers: answers })
            });

            if (resp.ok) {
                localStorage.removeItem(OFFLINE_KEY);
                console.log('Offline answers synced');
            }
        } catch (e) {
            console.warn('Sync failed, will retry later', e);
        }
    }

    // ══════════════════════════════════════════════════════════════
    // WEBCAM PROCTORING
    // ══════════════════════════════════════════════════════════════
    async function initWebcam() {
        try {
            webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            console.log('Webcam initialized for proctoring');

            // Take snapshot every 30 seconds
            setInterval(captureSnapshot, 30000);
            captureSnapshot(); // Initial snapshot
        } catch (e) {
            console.warn('Webcam not available', e);
        }
    }

    async function captureSnapshot() {
        if (!webcamStream) return;

        try {
            const video = document.createElement('video');
            video.srcObject = webcamStream;
            await video.play();

            const canvas = document.createElement('canvas');
            canvas.width = 320;
            canvas.height = 240;
            canvas.getContext('2d').drawImage(video, 0, 0, 320, 240);

            const snapshot = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];

            await fetch('/api/proctoring/snapshot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ snapshot: snapshot, type: 'periodic', suspicious: 0 })
            });
        } catch (e) {
            console.warn('Snapshot failed', e);
        }
    }

    // ══════════════════════════════════════════════════════════════
    // NETWORK STATUS
    // ══════════════════════════════════════════════════════════════
    window.addEventListener('online', () => {
        console.log('Back online, syncing...');
        syncOfflineAnswers();
    });

    window.addEventListener('offline', () => {
        console.log('Offline mode activated');
    });

    // ══════════════════════════════════════════════════════════════
    // INIT
    // ══════════════════════════════════════════════════════════════
    updateTimer();
    initWebcam();
    syncOfflineAnswers();
</script>
{% endblock %}

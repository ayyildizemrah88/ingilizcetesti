{% extends "base.html" %}
{% block title %}CEFR Skill Report - Skills Test Center{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}">
<style>
    .cefr-badge {
        font-size: 2rem;
        padding: 0.5rem 1.5rem;
        border-radius: 10px;
    }

    .cefr-A1 {
        background: #e74c3c;
        color: white;
    }

    .cefr-A2 {
        background: #e67e22;
        color: white;
    }

    .cefr-B1 {
        background: #f1c40f;
        color: black;
    }

    .cefr-B2 {
        background: #2ecc71;
        color: white;
    }

    .cefr-C1 {
        background: #3498db;
        color: white;
    }

    .cefr-C2 {
        background: #9b59b6;
        color: white;
    }

    .skill-bar {
        height: 30px;
        border-radius: 15px;
        background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
        position: relative;
        overflow: hidden;
    }

    .skill-bar::after {
        content: '';
        position: absolute;
        left: var(--score, 0%);
        top: 0;
        right: 0;
        bottom: 0;
        background: #e9ecef;
    }

    .skill-marker {
        position: absolute;
        left: var(--score, 0%);
        top: -5px;
        width: 2px;
        height: 40px;
        background: #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4" role="main" aria-labelledby="report-title">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h1 id="report-title" class="h4 mb-0">
                <i class="bi bi-bar-chart" aria-hidden="true"></i>
                CEFR Skill Assessment Report
            </h1>
        </div>

        <div class="card-body">
            <!-- Candidate Info -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <h2 class="h5">{{ aday.ad_soyad }}</h2>
                    <p class="text-muted mb-0">
                        Test completed: {{ aday.bitis_tarihi }}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="cefr-badge cefr-{{ skill_results.overall.cefr }}">
                        {{ skill_results.overall.cefr }}
                    </span>
                    <p class="mt-2 mb-0">
                        <strong>IELTS Band:</strong> {{ skill_results.overall.band }}
                    </p>
                </div>
            </div>

            <hr>

            <!-- Overall Description -->
            <div class="alert alert-info" role="alert">
                <h3 class="h6"><i class="bi bi-info-circle" aria-hidden="true"></i> {{ skill_results.overall.cefr }} -
                    {{ skill_results.overall.description }}</h3>
                <p class="mb-0">Overall Score: <strong>{{ skill_results.overall.score }}%</strong></p>
            </div>

            <!-- Radar Chart -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <h3 class="h5 mb-3">Skill Overview</h3>
                    <canvas id="skillRadar" height="250"
                        aria-label="Skill radar chart showing scores for each language skill"></canvas>
                </div>

                <div class="col-md-6">
                    <h3 class="h5 mb-3">Skill Details</h3>

                    {% for skill_name in ['reading', 'listening', 'writing', 'speaking', 'grammar', 'vocabulary'] %}
                    {% if skill_name in skill_results %}
                    {% set skill = skill_results[skill_name] %}
                    <div class="skill-item mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <strong>{{ skill_name|capitalize }}</strong>
                            <span class="badge cefr-{{ skill.cefr }}">{{ skill.cefr }}</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar {% if skill.score >= 75 %}bg-success{% elif skill.score >= 40 %}bg-warning{% else %}bg-danger{% endif %}"
                                role="progressbar" style="width: {{ skill.score }}%" aria-valuenow="{{ skill.score }}"
                                aria-valuemin="0" aria-valuemax="100">
                                {{ skill.score }}%
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <hr>

            <!-- Can-Do Statements -->
            <h3 class="h5 mb-3">What You Can Do at {{ skill_results.overall.cefr }} Level</h3>

            <div class="row g-3">
                {% for skill_name in ['reading', 'listening', 'writing', 'speaking'] %}
                {% if skill_name in skill_results %}
                {% set skill = skill_results[skill_name] %}
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h4 class="h6 mb-0 d-flex align-items-center">
                                {% if skill_name == 'reading' %}
                                <i class="bi bi-book me-2" aria-hidden="true"></i>
                                {% elif skill_name == 'listening' %}
                                <i class="bi bi-headphones me-2" aria-hidden="true"></i>
                                {% elif skill_name == 'writing' %}
                                <i class="bi bi-pencil me-2" aria-hidden="true"></i>
                                {% elif skill_name == 'speaking' %}
                                <i class="bi bi-mic me-2" aria-hidden="true"></i>
                                {% endif %}
                                {{ skill_name|capitalize }}
                                <span class="badge cefr-{{ skill.cefr }} ms-auto">{{ skill.cefr }}</span>
                            </h4>
                        </div>
                        <div class="card-body">
                            <p class="mb-0">{{ skill.can_do }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- CEFR Scale Reference -->
            <div class="mt-4">
                <h3 class="h5 mb-3">CEFR Level Reference</h3>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Level</th>
                                <th>Category</th>
                                <th>IELTS</th>
                                <th>TOEFL iBT</th>
                                <th>Score Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="{% if skill_results.overall.cefr == 'C2' %}table-primary{% endif %}">
                                <td><span class="badge cefr-C2">C2</span></td>
                                <td>Proficient - Mastery</td>
                                <td>8.5 - 9.0</td>
                                <td>110 - 120</td>
                                <td>90 - 100%</td>
                            </tr>
                            <tr class="{% if skill_results.overall.cefr == 'C1' %}table-primary{% endif %}">
                                <td><span class="badge cefr-C1">C1</span></td>
                                <td>Proficient - Advanced</td>
                                <td>7.0 - 8.0</td>
                                <td>87 - 109</td>
                                <td>75 - 89%</td>
                            </tr>
                            <tr class="{% if skill_results.overall.cefr == 'B2' %}table-primary{% endif %}">
                                <td><span class="badge cefr-B2">B2</span></td>
                                <td>Independent - Upper Intermediate</td>
                                <td>5.5 - 6.5</td>
                                <td>57 - 86</td>
                                <td>60 - 74%</td>
                            </tr>
                            <tr class="{% if skill_results.overall.cefr == 'B1' %}table-primary{% endif %}">
                                <td><span class="badge cefr-B1">B1</span></td>
                                <td>Independent - Intermediate</td>
                                <td>4.0 - 5.0</td>
                                <td>19 - 56</td>
                                <td>40 - 59%</td>
                            </tr>
                            <tr class="{% if skill_results.overall.cefr == 'A2' %}table-primary{% endif %}">
                                <td><span class="badge cefr-A2">A2</span></td>
                                <td>Basic - Elementary</td>
                                <td>3.0 - 3.5</td>
                                <td>10 - 18</td>
                                <td>20 - 39%</td>
                            </tr>
                            <tr class="{% if skill_results.overall.cefr == 'A1' %}table-primary{% endif %}">
                                <td><span class="badge cefr-A1">A1</span></td>
                                <td>Basic - Beginner</td>
                                <td>2.0 - 2.5</td>
                                <td>0 - 9</td>
                                <td>0 - 19%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-between mt-4">
                {% if aday.certificate_hash %}
                <a href="{{ url_for('cert_download', cert_hash=aday.certificate_hash) }}" class="btn btn-success">
                    <i class="bi bi-download" aria-hidden="true"></i> Download Certificate
                </a>
                {% endif %}

                <a href="{{ url_for('sinav_bitti') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Results
                </a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ctx = document.getElementById('skillRadar').getContext('2d');

        const chartData = {{ radar_data| tojson | safe
    }};

    new Chart(ctx, {
        type: 'radar',
        data: chartData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                r: {
                    min: 0,
                    max: 100,
                    ticks: {
                        stepSize: 20,
                        callback: function (value) {
                            const levels = { 0: 'A1', 20: 'A2', 40: 'B1', 60: 'B2', 80: 'C1', 100: 'C2' };
                            return levels[value] || '';
                        }
                    },
                    pointLabels: {
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}

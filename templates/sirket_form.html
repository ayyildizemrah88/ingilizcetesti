{% extends "base.html" %}

{% block title %}{{ 'Şirket Düzenle' if sirket else 'Yeni Şirket Ekle' }}{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Navigation -->
    <div class="mb-3">
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-house-fill me-1"></i>Dashboard
        </a>
        <a href="{{ url_for('admin.sirketler') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i>Şirketler
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">

            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">{{ 'edit' if sirket else 'domain_add' }}</i>
                        {{ 'Şirket Düzenle' if sirket else 'Yeni Şirket Ekle' }}
                    </h5>
                </div>
                <div class="card-body">

                    <!-- Flash Messages -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% endwith %}

                    <form method="POST">
                        <!-- CSRF Token for Security -->
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <!-- Şirket Adı -->
                        <div class="mb-3">
                            <label for="isim" class="form-label">Şirket Adı *</label>
                            <input type="text" class="form-control" id="isim" name="isim"
                                value="{{ sirket.isim if sirket else '' }}" required>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label for="email" class="form-label">Şirket E-posta</label>
                            <input type="email" class="form-control" id="email" name="email"
                                value="{{ sirket.email if sirket else '' }}" placeholder="sirket@ornek.com">
                        </div>

                        <!-- Telefon -->
                        <div class="mb-3">
                            <label for="telefon" class="form-label">Telefon</label>
                            <input type="tel" class="form-control" id="telefon" name="telefon"
                                value="{{ sirket.telefon if sirket else '' }}">
                        </div>

                        <!-- Adres -->
                        <div class="mb-3">
                            <label for="adres" class="form-label">Adres</label>
                            <textarea class="form-control" id="adres" name="adres"
                                rows="2">{{ sirket.adres if sirket else '' }}</textarea>
                        </div>

                        {% if sirket %}
                        <!-- Mevcut Şirket Admin Bilgileri (Düzenleme Modu) -->
                        <hr>
                        <h6 class="mb-3 text-muted">
                            <i class="material-icons align-middle me-1"
                                style="font-size: 18px;">admin_panel_settings</i>
                            Şirket Yetkilisi Bilgileri
                        </h6>

                        {% if admin_user %}
                        <div class="alert alert-secondary mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Yetkili Adı:</small>
                                    <strong>{{ admin_user.ad_soyad }}</strong>
                                </div>
                                <div class="col-md-6">
                                    <small class="text-muted d-block">Yetkili E-posta:</small>
                                    <strong>{{ admin_user.email }}</strong>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted d-block">Mevcut Şifre:</small>
                                    <div class="input-group">
                                        <input type="password" class="form-control form-control-sm bg-light"
                                            id="current_password_display"
                                            value="{{ admin_user.plain_password or '********' }}" readonly>
                                        <button class="btn btn-outline-secondary btn-sm" type="button"
                                            onclick="togglePasswordVisibility()">
                                            <i class="fas fa-eye" id="password_toggle_icon"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">
                                        {% if not admin_user.plain_password %}
                                        (Şifre şifreli olarak saklanmaktadır)
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Şifre Yenileme Bölümü -->
                        <div class="card bg-warning bg-opacity-10 border-warning mb-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-key me-2"></i>Şifre Yenileme
                                </h6>
                                <div class="mb-2">
                                    <label for="new_password" class="form-label small">Yeni Şifre</label>
                                    <input type="password" class="form-control" id="new_password" name="new_password"
                                        minlength="8" placeholder="En az 8 karakter (boş bırakılırsa değişmez)">
                                </div>
                                <div class="mb-0">
                                    <label for="new_password_confirm" class="form-label small">Yeni Şifre
                                        (Tekrar)</label>
                                    <input type="password" class="form-control" id="new_password_confirm"
                                        name="new_password_confirm" minlength="8" placeholder="Şifreyi tekrar girin">
                                </div>
                                <small class="text-muted">Şifreyi değiştirmek istemiyorsanız bu alanları boş
                                    bırakın.</small>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Bu şirkete ait admin kullanıcısı bulunamadı.
                        </div>
                        {% endif %}

                        {% else %}
                        <!-- Yeni Şirket için Admin Bilgileri -->
                        <!-- Başlangıç Kredisi (sadece yeni şirket için) -->
                        <div class="mb-3">
                            <label for="kredi" class="form-label">Başlangıç Kredisi</label>
                            <input type="number" class="form-control" id="kredi" name="kredi" value="10" min="0">
                            <div class="form-text">Her sınav 1 kredi tüketir.</div>
                        </div>

                        <!-- Admin Kullanıcı Bilgileri -->
                        <hr>
                        <h6 class="mb-3 text-muted">
                            <i class="material-icons align-middle me-1"
                                style="font-size: 18px;">admin_panel_settings</i>
                            Müşteri Admin Kullanıcı
                        </h6>

                        <div class="mb-3">
                            <label for="admin_email" class="form-label">Admin E-posta *</label>
                            <input type="email" class="form-control" id="admin_email" name="admin_email" required
                                placeholder="admin@sirket.com">
                            <div class="form-text">Bu e-posta ile müşteri admin panele giriş yapabilecek.</div>
                        </div>

                        <div class="mb-3">
                            <label for="admin_ad_soyad" class="form-label">Admin Ad Soyad *</label>
                            <input type="text" class="form-control" id="admin_ad_soyad" name="admin_ad_soyad" required
                                placeholder="Admin kullanıcının adı soyadı">
                        </div>

                        <div class="mb-3">
                            <label for="admin_password" class="form-label">Admin Şifre *</label>
                            <input type="password" class="form-control" id="admin_password" name="admin_password"
                                required minlength="8" placeholder="En az 8 karakter">
                            <div class="form-text">Bu şifre ile müşteri admin panele giriş yapabilecek.</div>
                        </div>
                        {% endif %}

                        <!-- Submit -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="material-icons align-middle me-1">save</i>
                                {{ 'Güncelle' if sirket else 'Kaydet' }}
                            </button>
                            <a href="{{ url_for('admin.sirketler') }}" class="btn btn-outline-secondary">
                                <i class="material-icons align-middle me-1">cancel</i>
                                İptal
                            </a>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    function togglePasswordVisibility() {
        const passwordField = document.getElementById('current_password_display');
        const toggleIcon = document.getElementById('password_toggle_icon');

        if (passwordField.type === 'password') {
            passwordField.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        } else {
            passwordField.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    }
</script>
{% endblock %}

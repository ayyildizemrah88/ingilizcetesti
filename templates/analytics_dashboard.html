{% extends "base.html" %}
{% block title %}Analytics Dashboard - Skills Test Center{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="fas fa-chart-line me-2"></i>Analytics Dashboard</h2>
            <p class="text-muted mb-0">Gerçek zamanlı platform istatistikleri</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('analytics.question_analytics') }}" class="btn btn-outline-primary">
                <i class="fas fa-question-circle me-1"></i> Soru Analizi
            </a>
            <a href="{{ url_for('analytics.fraud_dashboard') }}" class="btn btn-outline-danger">
                <i class="fas fa-shield-alt me-1"></i> Fraud Tespiti
            </a>
        </div>
    </div>

    <!-- Real-time Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0">{{ stats.active_exams if stats else 0 }}</h2>
                            <small class="opacity-75">Aktif Sınav</small>
                        </div>
                        <div class="opacity-50">
                            <i class="fas fa-play-circle fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0">{{ stats.today_completed if stats else 0 }}</h2>
                            <small class="opacity-75">Bugün Tamamlanan</small>
                        </div>
                        <div class="opacity-50">
                            <i class="fas fa-check-circle fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0">{{ stats.total_candidates if stats else 0 }}</h2>
                            <small class="opacity-75">Toplam Aday</small>
                        </div>
                        <div class="opacity-50">
                            <i class="fas fa-users fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-warning text-dark h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0">%{{ '%.1f'|format(stats.avg_score if stats else 0) }}</h2>
                            <small class="opacity-75">Ortalama Puan</small>
                        </div>
                        <div class="opacity-50">
                            <i class="fas fa-star fa-3x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row g-4 mb-4">
        <!-- CEFR Distribution -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0"><i class="fas fa-layer-group me-2"></i>CEFR Seviye Dağılımı</h6>
                </div>
                <div class="card-body">
                    <canvas id="cefrChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <!-- Weekly Trend -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Son 7 Gün Trendi</h6>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row g-4 mb-4">
        <!-- Company Comparison -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0"><i class="fas fa-building me-2"></i>Şirket Karşılaştırması</h6>
                </div>
                <div class="card-body">
                    <canvas id="companyChart" height="250"></canvas>
                </div>
            </div>
        </div>
        <!-- Skill Averages -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0"><i class="fas fa-brain me-2"></i>Yetenek Ortalamaları</h6>
                </div>
                <div class="card-body">
                    <canvas id="skillChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Row -->
    <div class="row g-4">
        <!-- Top Performers -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0"><i class="fas fa-trophy me-2 text-warning"></i>En Yüksek Puanlar (Son 7 Gün)</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Sıra</th>
                                    <th>Aday</th>
                                    <th>Puan</th>
                                    <th>Seviye</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for candidate in top_performers %}
                                <tr>
                                    <td>
                                        {% if loop.index == 1 %}
                                        <i class="fas fa-medal text-warning"></i>
                                        {% elif loop.index == 2 %}
                                        <i class="fas fa-medal text-secondary"></i>
                                        {% elif loop.index == 3 %}
                                        <i class="fas fa-medal" style="color: #cd7f32;"></i>
                                        {% else %}
                                        {{ loop.index }}
                                        {% endif %}
                                    </td>
                                    <td>{{ candidate.ad_soyad }}</td>
                                    <td><strong>{{ candidate.puan or 0 }}</strong></td>
                                    <td>
                                        <span
                                            class="badge {% if candidate.seviye_sonuc in ['C1', 'C2'] %}bg-danger{% elif candidate.seviye_sonuc in ['B1', 'B2'] %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                            {{ candidate.seviye_sonuc or 'N/A' }}
                                        </span>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2 d-block opacity-50"></i>
                                        Son 7 günde tamamlanan sınav yok
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Alerts -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h6 class="mb-0"><i class="fas fa-bell me-2 text-danger"></i>Sistem Uyarıları</h6>
                </div>
                <div class="card-body">
                    {% if alerts and alerts|length > 0 %}
                    <div class="list-group list-group-flush">
                        {% for alert in alerts %}
                        <div class="list-group-item border-0 px-0">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <span class="badge bg-{{ alert.type }} rounded-circle p-2">
                                        <i class="fas fa-{{ alert.icon or 'exclamation' }}"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <p class="mb-0">{{ alert.message }}</p>
                                    <small class="text-muted">{{ alert.time }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-3x mb-3 text-success opacity-50"></i>
                        <p class="mb-0">Sistem uyarısı yok</p>
                        <small>Her şey yolunda görünüyor!</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart data from server
    var cefrData = {{ cefr_distribution| tojson |default ([0, 0, 0, 0, 0, 0]) }};
    var trendLabels = {{ trend_labels| tojson |default ([]) }};
    var trendData = {{ trend_data| tojson |default ([]) }};
    var companyNames = {{ company_names| tojson |default ([]) }};
    var companyScores = {{ company_scores| tojson |default ([]) }};
    var skillAverages = {{ skill_averages| tojson |default ([0, 0, 0, 0, 0, 0]) }};

    // CEFR Distribution Chart
    var cefrCtx = document.getElementById('cefrChart').getContext('2d');
    new Chart(cefrCtx, {
        type: 'doughnut',
        data: {
            labels: ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'],
            datasets: [{
                data: cefrData,
                backgroundColor: ['#28a745', '#20c997', '#ffc107', '#fd7e14', '#dc3545', '#6f42c1'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });

    // Weekly Trend Chart
    var trendCtx = document.getElementById('trendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: trendLabels,
            datasets: [{
                label: 'Tamamlanan Sınav',
                data: trendData,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    // Company Comparison Chart
    var companyCtx = document.getElementById('companyChart').getContext('2d');
    new Chart(companyCtx, {
        type: 'bar',
        data: {
            labels: companyNames,
            datasets: [{
                label: 'Ortalama Puan',
                data: companyScores,
                backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, max: 100 } }
        }
    });

    // Skill Averages Chart
    var skillCtx = document.getElementById('skillChart').getContext('2d');
    new Chart(skillCtx, {
        type: 'radar',
        data: {
            labels: ['Grammar', 'Vocabulary', 'Reading', 'Listening', 'Speaking', 'Writing'],
            datasets: [{
                label: 'Ortalama Puan',
                data: skillAverages,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(75, 192, 192, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { r: { beginAtZero: true, max: 100 } }
        }
    });
</script>
{% endblock %}

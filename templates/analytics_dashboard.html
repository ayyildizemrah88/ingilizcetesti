{% extends "base.html" %}
{% block title %}Analytics Dashboard - Skills Test Center{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="bi bi-graph-up-arrow me-2"></i>Analytics Dashboard</h3>
        <span class="badge bg-primary"><i class="bi bi-clock me-1"></i>Gerçek Zamanlı</span>
    </div>

    <!-- Live Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body text-center">
                    <h2>{{ stats.active_exams if stats else 0 }}</h2>
                    <small>Aktif Sınav</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-success text-white">
                <div class="card-body text-center">
                    <h2>{{ stats.today_completed if stats else 0 }}</h2>
                    <small>Bugün Tamamlanan</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-info text-white">
                <div class="card-body text-center">
                    <h2>{{ stats.total_candidates if stats else 0 }}</h2>
                    <small>Toplam Aday</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 bg-warning text-dark">
                <div class="card-body text-center">
                    <h2>{{ '%.1f'|format(stats.avg_score if stats else 0) }}%</h2>
                    <small>Ortalama Puan</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- CEFR Distribution Chart -->
        <div class="col-md-6">
            <div class="card border-0 h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>CEFR Seviye Dağılımı</h6>
                </div>
                <div class="card-body">
                    <canvas id="cefrChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="col-md-6">
            <div class="card border-0 h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Son 7 Gün Trendi</h6>
                </div>
                <div class="card-body">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mt-2">
        <!-- Company Comparison -->
        <div class="col-md-6">
            <div class="card border-0 h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-building me-2"></i>Şirket Karşılaştırması</h6>
                </div>
                <div class="card-body">
                    <canvas id="companyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Skill Averages -->
        <div class="col-md-6">
            <div class="card border-0 h-100">
                <div class="card-header bg-white">
                    <h6 class="mb-0"><i class="bi bi-star me-2"></i>Yetenek Ortalamaları</h6>
                </div>
                <div class="card-body">
                    <canvas id="skillChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Performers -->
    <div class="card border-0 mt-4">
        <div class="card-header bg-white">
            <h6 class="mb-0"><i class="bi bi-trophy me-2"></i>En Yüksek Puanlar (Son 7 Gün)</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Ad Soyad</th>
                            <th>Puan</th>
                            <th>Seviye</th>
                            <th>Tarih</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if top_performers %}
                        {% for c in top_performers %}
                        <tr>
                            <td><span class="badge bg-warning">{{ loop.index }}</span></td>
                            <td><strong>{{ c.ad_soyad }}</strong></td>
                            <td><span class="badge bg-primary">{{ '%.1f'|format(c.puan or 0) }}%</span></td>
                            <td><span class="badge bg-success">{{ c.seviye_sonuc or '-' }}</span></td>
                            <td>{{ c.bitis_tarihi.strftime('%d.%m.%Y') if c.bitis_tarihi else '-' }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center text-muted py-4">Henüz veri yok</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Alerts -->
    {% if alerts %}
    <div class="card border-0 mt-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Sistem Uyarıları</h6>
        </div>
        <div class="card-body">
            {% for alert in alerts %}
            <div class="alert alert-{{ alert.type or 'warning' }} mb-2">
                <i class="bi bi-{{ alert.icon or 'info-circle' }} me-2"></i>{{ alert.message }}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // CEFR Distribution Chart
    const cefrCtx = document.getElementById('cefrChart').getContext('2d');
    new Chart(cefrCtx, {
        type: 'doughnut',
        data: {
            labels: ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'],
            datasets: [{
                data: {{ cefr_distribution | tojson if cefr_distribution else [0, 0, 0, 0, 0, 0] | safe
        }
    },
        backgroundColor: [
        '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#17a2b8', '#6f42c1'
    ]
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: true
    }
    });

    // Trend Chart
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ trend_labels | tojson if trend_labels else[] | safe }},
    datasets: [{
        label: 'Tamamlanan Sınav',
        data: {{ trend_data | tojson if trend_data else[] | safe }},
    borderColor: '#0d6efd',
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
            fill: true,
                tension: 0.4
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: true,
                scales: {
            y: {
                beginAtZero: true
            }
        }
    }
    });

    // Company Comparison Chart
    const companyCtx = document.getElementById('companyChart').getContext('2d');
    new Chart(companyCtx, {
        type: 'bar',
        data: {
            labels: {{ company_names | tojson if company_names else[] | safe }},
    datasets: [{
        label: 'Ortalama Puan',
        data: {{ company_scores | tojson if company_scores else[] | safe }},
    backgroundColor: '#0d6efd'
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: true,
                scales: {
            y: {
                beginAtZero: true,
                    max: 100
            }
        }
    }
    });

    // Skill Averages Chart
    const skillCtx = document.getElementById('skillChart').getContext('2d');
    new Chart(skillCtx, {
        type: 'radar',
        data: {
            labels: ['Grammar', 'Vocabulary', 'Reading', 'Listening', 'Speaking', 'Writing'],
            datasets: [{
                label: 'Ortalama',
                data: {{ skill_averages | tojson if skill_averages else [0, 0, 0, 0, 0, 0] | safe
        }
    },
        borderColor: '#0d6efd',
        backgroundColor: 'rgba(13, 110, 253, 0.2)'
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            r: {
                beginAtZero: true,
                max: 100
            }
        }
    }
    });
</script>
{% endblock %}

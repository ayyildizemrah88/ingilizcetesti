{% extends "dashboard.html" %}
{% block title %}Soru Analitiği - Skills Test Center{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-question-circle me-2"></i>Soru Analitiği</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="runCalibration()">
                    <i class="bi bi-cpu me-1"></i>Kalibrasyon Çalıştır
                </button>
                <a href="/admin/questions" class="btn btn-outline-secondary">
                    <i class="bi bi-list me-1"></i>Soru Listesi
                </a>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="display-5 text-primary">{{ stats.total_questions }}</div>
                <small class="text-muted">Toplam Soru</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="display-5 text-success">{{ stats.calibrated }}</div>
                <small class="text-muted">Kalibre Edilmiş</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="display-5 text-warning">{{ stats.warnings }}</div>
                <small class="text-muted">Uyarı</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <div class="display-5 text-info">{{ stats.avg_accuracy|round(1) }}%</div>
                <small class="text-muted">Ort. Doğruluk</small>
            </div>
        </div>
    </div>

    <!-- Difficulty Distribution -->
    <div class="col-lg-6 mt-4">
        <div class="card border-0 shadow">
            <div class="card-header bg-white">
                <h5 class="mb-0">Zorluk Dağılımı (Etiketli vs Hesaplanan)</h5>
            </div>
            <div class="card-body">
                <canvas id="difficultyChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Category Distribution -->
    <div class="col-lg-6 mt-4">
        <div class="card border-0 shadow">
            <div class="card-header bg-white">
                <h5 class="mb-0">Kategori ve Başarı Oranları</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Calibration Warnings -->
    <div class="col-12 mt-4">
        <div class="card border-0 shadow">
            <div class="card-header bg-warning">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Kalibrasyon Uyarıları</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Soru ID</th>
                                <th>Kategori</th>
                                <th>Etiket</th>
                                <th>Hesaplanan</th>
                                <th>Fark</th>
                                <th>Cevaplanma</th>
                                <th>Doğruluk</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for q in warnings %}
                            <tr>
                                <td>#{{ q.id }}</td>
                                <td><span class="badge bg-secondary">{{ q.kategori }}</span></td>
                                <td><span class="badge bg-primary">{{ q.zorluk }}</span></td>
                                <td><span class="badge bg-warning text-dark">{{ q.suggested }}</span></td>
                                <td class="text-danger fw-bold">{{ q.diff_levels }} seviye</td>
                                <td>{{ q.times_answered }}</td>
                                <td>{{ q.accuracy|round(1) }}%</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary"
                                        onclick="updateDifficulty({{ q.id }}, '{{ q.suggested }}')">
                                        <i class="bi bi-arrow-repeat"></i> Güncelle
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not warnings %}
                            <tr>
                                <td colspan="8" class="text-center py-4 text-muted">
                                    <i class="bi bi-check-circle fs-3"></i>
                                    <p class="mb-0 mt-2">Kalibrasyon uyarısı yok</p>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Performance Table -->
    <div class="col-12 mt-4">
        <div class="card border-0 shadow">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Soru Performansı</h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm w-auto" id="categoryFilter">
                        <option value="">Tüm Kategoriler</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                    <select class="form-select form-select-sm w-auto" id="difficultyFilter">
                        <option value="">Tüm Seviyeler</option>
                        {% for level in ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'] %}
                        <option value="{{ level }}">{{ level }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="questionsTable">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Soru (kısaltılmış)</th>
                                <th>Kategori</th>
                                <th>Seviye</th>
                                <th>Cevaplanma</th>
                                <th>Doğruluk</th>
                                <th>Son Kalibrasyon</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for q in questions %}
                            <tr data-category="{{ q.kategori }}" data-difficulty="{{ q.zorluk }}">
                                <td>#{{ q.id }}</td>
                                <td>{{ q.soru_metni[:50] }}...</td>
                                <td><span class="badge bg-secondary">{{ q.kategori }}</span></td>
                                <td><span class="badge bg-primary">{{ q.zorluk }}</span></td>
                                <td>{{ q.times_answered or 0 }}</td>
                                <td>
                                    {% set acc = (q.times_correct / q.times_answered * 100) if q.times_answered else 0
                                    %}
                                    <span class="badge bg-{{ 'success' if acc >= 50 else 'danger' }}">
                                        {{ acc|round(1) }}%
                                    </span>
                                </td>
                                <td>{{ q.last_calibrated.strftime('%d.%m.%Y') if q.last_calibrated else '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Difficulty Chart
    new Chart(document.getElementById('difficultyChart'), {
        type: 'bar',
        data: {
            labels: ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'],
            datasets: [
                { label: 'Etiketli', data: {{ labeled_dist | tojson | safe }
    }, backgroundColor: '#667eea' },
        { label: 'Hesaplanan', data: {{ calculated_dist | tojson | safe }}, backgroundColor: '#ffc107' }
            ]
        },
        options: { responsive: true }
    });

    // Category Chart
    new Chart(document.getElementById('categoryChart'), {
        type: 'bar',
        data: {
            labels: {{ cat_names| tojson | safe }},
        datasets: [{
            label: 'Doğruluk %',
            data: {{ cat_accuracy| tojson | safe }},
        backgroundColor: '#28a745'
        }]
    },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
});

    // Filters
    document.getElementById('categoryFilter').onchange = filterTable;
    document.getElementById('difficultyFilter').onchange = filterTable;

    function filterTable() {
        const cat = document.getElementById('categoryFilter').value;
        const diff = document.getElementById('difficultyFilter').value;
        document.querySelectorAll('#questionsTable tbody tr').forEach(row => {
            const matchCat = !cat || row.dataset.category === cat;
            const matchDiff = !diff || row.dataset.difficulty === diff;
            row.style.display = matchCat && matchDiff ? '' : 'none';
        });
    }

    function runCalibration() {
        if (!confirm('Kalibrasyon çalıştırılsın mı?')) return;
        fetch('/api/calibrate', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(`Kalibrasyon tamamlandı: ${data.calibrated} soru kalibre edildi, ${data.warnings} uyarı.`);
                location.reload();
            });
    }

    function updateDifficulty(questionId, newLevel) {
        if (!confirm(`Soru #${questionId} zorluğu ${newLevel} olarak güncellensin mi?`)) return;
        fetch(`/api/questions/${questionId}/difficulty`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ zorluk: newLevel })
        })
            .then(r => r.json())
            .then(() => location.reload());
    }
</script>
{% endblock %}
